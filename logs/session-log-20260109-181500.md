# ShadowTree Session Log

**Date:** Friday, January 9, 2026
**Time:** 18:15:00
**Agent:** Claude Opus 4.5
**Objective:** Initial project scaffolding - build privacy-hardened Shadowrocket config system.

---

## 1. Context

User had forked LOWERTOP/Shadowrocket (a Chinese Shadowrocket config) and wanted to transform it into a privacy-hardened config for US-based users. Project requirements defined in CLAUDE.md.

## 2. Work Completed

### A. Directory Structure
Created full project structure per CLAUDE.md spec:
```
scripts/          # build.sh, test.sh
overrides/        # dns.conf
rulesets/         # 8 privacy blocking lists
tests/rules/      # must_block.txt, must_allow.txt
tests/reports/    # test output
audit/            # upstream-review.md
dist/             # built config output
upstream/         # cached upstream config
```

### B. Build System (`scripts/build.sh`)
Implemented automated build pipeline:
1. Fetches latest upstream from LOWERTOP
2. Applies DNS override (Chinese → Cloudflare/Quad9)
3. Removes China-specific services (BiliBili, WeChat, Baidu, etc.)
4. Removes GEOIP,CN,DIRECT rule
5. Inserts privacy blocking rules from rulesets/
6. Adds ShadowTree header
7. Validates syntax
8. Outputs to dist/shadowtree.conf

### C. Test System (`scripts/test.sh`)
Implemented TDD validation:
- Syntax validation (required sections exist)
- DNS verification (privacy DNS configured, Chinese DNS removed)
- must_block assertions (26 domains that must be blocked)
- must_allow assertions (22 domains that must NOT be blocked)
- Coverage reporting

### D. DNS Override (`overrides/dns.conf`)
Replaced Chinese DNS:
```
# FROM:
dns-server = https://doh.pub/dns-query,https://dns.alidns.com/dns-query,223.5.5.5,119.29.29.29

# TO:
dns-server = https://cloudflare-dns.com/dns-query,https://dns.quad9.net/dns-query,1.1.1.1,9.9.9.9
```

### E. Privacy Rulesets (8 files)
Created seed blocklists for each threat category:

| File | Domains | Policy | Purpose |
|------|---------|--------|---------|
| data-brokers.list | ~45 | REJECT-DROP | Spokeo, Whitepages, Acxiom, etc. |
| gov-surveillance.list | ~25 | REJECT-DROP | Palantir, Clearview AI, NSO Group adjacent |
| analytics.list | ~50 | REJECT | Google Analytics, Mixpanel, Hotjar, etc. |
| advertising.list | ~45 | REJECT | DoubleClick, Taboola, Criteo, etc. |
| telemetry.list | ~40 | REJECT | Apple/Microsoft/Samsung/LG telemetry |
| location-brokers.list | ~25 | REJECT-DROP | SafeGraph, Placer.ai, Cuebiq, etc. |
| isp-tracking.list | ~15 | REJECT-DROP | Verizon/AT&T supercookies |
| research.list | 0 | REJECT | Placeholder for unverified domains |

### F. Test Data
- `must_block.txt`: 26 domains across all threat categories
- `must_allow.txt`: 22 legitimate domains (GitHub, Signal, banks, etc.)

### G. Upstream Audit (`audit/upstream-review.md`)
Documented security review of LOWERTOP config:
- Chinese DNS (replaced)
- Chinese services (removed)
- GEOIP,CN rule (removed)
- MITM config (reviewed, only google.cn - acceptable)
- URL rewrites (reviewed, only google.cn redirect - acceptable)

## 3. Results

- **Build**: Successful, 334 upstream lines → 607 output lines
- **Tests**: 57/57 passing (later expanded to 65 by Gemini)
- **Config**: `dist/shadowtree.conf` ready for Shadowrocket import

## 4. User Decisions

- Remove all China-specific services (user is US-based)
- Focus on lazy_group.conf (with proxy groups) over lazy.conf
- Use REJECT-DROP for surveillance, REJECT for ads/analytics

---

**Status:** Project scaffolding complete. Build system functional. Ready for ruleset expansion.
